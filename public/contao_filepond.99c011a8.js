import FilePondPluginImageResize from"filepond-plugin-image-resize";import FilePondPluginImageTransform from"filepond-plugin-image-transform";import FilePondPluginImagePreview from"filepond-plugin-image-preview";import FilePondPluginImageExifOrientation from"filepond-plugin-image-exif-orientation";import FilePondPluginImageEdit from"filepond-plugin-image-edit";import FilePondPluginFileValidateType from"filepond-plugin-file-validate-type";import*as FilePond from"filepond/dist/filepond.esm.js";import{EventDispatcher}from"./event_dispatcher.js";import{ListenerProvider}from"./listener_provider.js";const listenerProvider=new ListenerProvider,eventDispatcher=new EventDispatcher(listenerProvider),modules=import.meta.webpackContext("./custom_validators",{recursive:!1,regExp:/\.js$/});modules.keys().forEach(e=>{const i=modules(e);for(const e of Object.values(i))if("function"==typeof e&&Array.isArray(e.tags)){const i=new e;for(const t of e.tags)listenerProvider.register(t.event,i,t.priority??0)}});export default class ContaoFilepond{wrapper=null;widget=null;name=null;jsConfig=null;#e=!1;#i=null;#t={imageResizeTargetWidth:1200,imageResizeTargetHeight:1200};#s=[FilePondPluginImageResize,FilePondPluginImageTransform,FilePondPluginImagePreview,FilePondPluginImageExifOrientation,FilePondPluginImageEdit,FilePondPluginFileValidateType];constructor(e,i,t){this.wrapper=e.closest(".filepond-wrapper"),this.widget=e,this.name=i,this.jsConfig=t,this.#i=FilePond,this.#o()}#o(){this.setAllowedExtensions(this.jsConfig.extensions),this.jsConfig.multiple?1===this.jsConfig.limit?(this.setAttribute("data-max-files",1),this.setAttribute("name",this.name),this.#e=!1):this.jsConfig.limit>1?(this.setAttribute("multiple",""),this.setAttribute("data-max-files",this.jsConfig.limit),this.setAttribute("name",this.name+"[]"),this.#e=!0):(this.setAttribute("multiple",""),this.setAttribute("name",this.name+"[]"),this.#e=!0):(this.setAttribute("data-max-files",1),this.setAttribute("name",this.name),this.#e=!1),this.jsConfig.minFileSizeLimit&&this.setAttribute("data-min-file-size",this.jsConfig.minFileSizeLimit),this.jsConfig.maxFileSizeLimit&&this.setAttribute("data-max-file-size",this.jsConfig.maxFileSizeLimit),this.#n(),this.setPlugins(this.#s)}getAttribute(e){return this.widget.getAttribute(e)}setAttribute(e,i){return this.widget.setAttribute(e,i),this}removeAttribute(e){return this.widget.removeAttribute(e),this}setAllowedExtensions(e){return this.widget.setAttribute("accept",e),this}setPlugins(e){return this.#s=e,this.#i.registerPlugin(...this.#s),this}getPond(){return this.#i}getOptions(){return this.#t}setOptions(e){return this.#t=e,this}run(){this.#i.create(this.widget,this.#t)}#n(){this.#t={...this.jsConfig.translations,maxParallelUploads:this.jsConfig.parallelUploads<1?1:this.jsConfig.parallelUploads,instantUpload:!0,allowMultiple:this.#e,allowFileTypeValidation:!0,allowRevert:!this.jsConfig.directUpload,allowRemove:!this.jsConfig.directUpload,oninit:()=>{this.#r()},onaddfile:(e,i)=>{this.#a(e,i)},onaddfilestart:e=>{this.#l(e)},onprocessfile:(e,i)=>{this.#d(e,i)},server:{process:async(e,i,t,s,o,n,r)=>{const a=t.itemId,l={itemId:a,fieldName:e,file:i,metadata:t,filepondOptions:this.#t,jsConfig:this.jsConfig,resolve(){},reject(e){}};try{await eventDispatcher.dispatch("contao_filepond:process_start",l),await this.#p(e,i,t,s,o,n,r)}catch(e){this.#h(a,e.message,o)}},revert:(e,i,t)=>{this.#f(e,i,t)},fetch:null},fileValidateTypeDetectType:(e,i)=>new Promise((i,t)=>{i(`.${e.name.split(".").pop().toLowerCase()}`)})},this.#t.allowFileSizeValidation=!0,this.#t.minFileSize=this.jsConfig.minFileSizeLimit,this.#t.maxFileSize=this.jsConfig.maxFileSizeLimit,this.jsConfig.imgResize&&this.jsConfig.imgResizeBrowser&&this.jsConfig.imgResizeWidth>0&&this.jsConfig.imgResizeHeight>0&&(this.#t.allowImageResize=!0,this.#t.imageResizeTargetWidth=this.jsConfig.imgResizeWidth,this.#t.imageResizeTargetHeight=this.jsConfig.imgResizeHeight,this.#t.imageResizeMode=this.jsConfig.imgResizeModeBrowser,this.#t.imageResizeUpscale=this.jsConfig.imgResizeUpscaleBrowser)}#r(){this.wrapper.classList.add("filepond--is-ready"),setInterval(()=>{this.wrapper.querySelector('.filepond--item[data-filepond-item-state="busy processing"]')||this.wrapper.classList.remove("filepond--is-busy")},1e3)}#a(e,i){i.setMetadata("itemId",i.id),i.setMetadata("options",this.getOptions())}#l(e){this.wrapper.classList.add("filepond--is-busy")}#d(e,i){}#h(e,i,t){t(i);const s=document.querySelector(`#filepond--item-${e} .filepond--file-status`),o=s?.querySelector(".filepond--file-status-main");if(s?.querySelector(".filepond--contao-error")?.remove(),o){const e=document.createElement("span");e.className="filepond--contao-error",e.style.fontSize="0.75rem",e.textContent=i,o.after(e)}}async#p(e,i,t,s,o,n,r){const a=t.itemId,l=document.querySelectorAll("#filepond--item-"+a+" .filepond--contao-error");for(const e of l)e.remove();if(!(!0===this.jsConfig.chunkUploads&&this.jsConfig.chunkSize>0&&i.size>this.jsConfig.chunkSize)){const t=await i.arrayBuffer(),l=await this.#m(t),d=new FormData;d.append(e,i,i.name),d.append("REQUEST_TOKEN",this.jsConfig.csrfToken),d.append("filePondItemId",a),d.append("fileChecksum",l);const p=new XMLHttpRequest;return p.open("POST",window.location.href),p.setRequestHeader("Accept","application/json"),p.setRequestHeader("name",this.name),p.setRequestHeader("action","filepond_upload"),p.setRequestHeader("X-Requested-With","XMLHttpRequest"),p.setRequestHeader("filePondItemId",a),p.upload.onprogress=e=>{n(e.lengthComputable,e.loaded,e.total)},p.onload=()=>{if(p.status>=200&&p.status<300){const e=JSON.parse(p.response);!1===e.success?this.#h(a,e.error??"Upload failed with error code 1.",o):!0===e.success?s(e.transferKey):this.#h(a,"Upload failed with error code 2.",o)}else this.#h(a,"Upload failed with error code 3.",o)},p.send(d),{abort:()=>{p.abort(),r()}}}let d=0,p=!1,h=null;const f=this.jsConfig.chunkSize,m=await i.arrayBuffer(),u=await this.#m(m),c=async()=>{if(p)return;const t=i.slice(d,d+f),r=new FormData;r.append("REQUEST_TOKEN",this.jsConfig.csrfToken),r.append(e.replace(/\[\]$/,"")+"_chunk",t),r.append("fileChecksum",u),r.append("fileName",i.name),r.append("offset",d),r.append("totalSize",i.size);const l=new AbortController;h=l;try{const e=await fetch(window.location.href,{method:"POST",headers:{Accept:"application/json",name:this.name,action:"filepond_upload_chunk","X-Requested-With":"XMLHttpRequest",filePondItemId:a},body:r,signal:l.signal});if(!e.ok)return void o("Upload error");const p=await e.json();if(!0!==p.success)return!1===p.success?void this.#h(a,p.error??"Chunk upload failed with error code 1.",o):void this.#h(a,"Chunk upload failed with error code 2.",o);d+=t.size,n(!0,d,i.size),d<i.size?await c():!0===p.directUpload?s(""):s(p.transferKey)}catch(e){if("AbortError"===e.name)return;o("Network error")}};return c(),{abort:()=>{p=!0,h&&h.abort(),r()}}}async#f(e,i,t){try{if(!(await fetch(window.location.href,{method:"DELETE",headers:{"Content-Type":"text/plain",name:this.name,action:"filepond_upload_revert",accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:e})).ok)throw new Error("Revert failed");i()}catch(e){t("Could not revert file.")}}async#m(e){const i=await crypto.subtle.digest("SHA-256",e);return[...new Uint8Array(i)].map(e=>e.toString(16).padStart(2,"0")).join("")}}