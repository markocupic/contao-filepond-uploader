class ContaoFilepondPlugin{wrapper=null;widget=null;name=null;jsConfig=null;#e=!1;#t=null;#i={};#s=[FilePondPluginImagePreview,FilePondPluginImageExifOrientation,FilePondPluginFileValidateSize,FilePondPluginImageEdit,FilePondPluginFileValidateType,FilePondPluginImageValidateSize];constructor(e,t,i,s){this.wrapper=e.closest(".filepond-wrapper"),this.widget=e,this.name=t,this.jsConfig=i,this.#t=s,this.#n()}#n(){this.setAllowedExtensions(this.jsConfig.extensions),this.jsConfig.multiple?1===this.jsConfig.limit?(this.setAttribute("data-max-files",1),this.setAttribute("name",this.name),this.#e=!1):this.jsConfig.limit>1?(this.setAttribute("multiple",""),this.setAttribute("data-max-files",this.jsConfig.limit),this.setAttribute("name",this.name+"[]"),this.#e=!0):(this.setAttribute("multiple",""),this.setAttribute("name",this.name+"[]"),this.#e=!0):(this.setAttribute("data-max-files",1),this.setAttribute("name",this.name),this.#e=!1),this.jsConfig.minSizeLimit&&this.setAttribute("data-min-file-size",this.jsConfig.minSizeLimit),this.jsConfig.maxSizeLimit&&this.setAttribute("data-max-file-size",this.jsConfig.maxSizeLimit),this.setPlugins(this.#s),this.#o()}getAttribute(e){return this.widget.getAttribute(e)}setAttribute(e,t){return this.widget.setAttribute(e,t),this}removeAttribute(e){return this.widget.removeAttribute(e),this}setAllowedExtensions(e){return this.widget.setAttribute("accept",e),this}setPlugins(e){return this.#s=e,this.#t.registerPlugin(...this.#s),this}getPond(){return this.#t}getOptions(){return this.#i}setOptions(e){return this.#i=e,this}run(){this.#t.create(this.widget,this.#i)}#o(){this.#i={...this.jsConfig.translations,maxParallelUploads:this.jsConfig.maxConnections<1?1:this.jsConfig.maxConnections,instantUpload:!0,allowMultiple:this.#e,allowFileTypeValidation:!0,oninit:()=>{this.#a()},onaddfilestart:e=>{this.#l(e)},onprocessfile:(e,t)=>{this.#r(e,t)},onaddfile:(e,t)=>{this.#d(e,t)},server:{process:(e,t,i,s,n,o,a)=>{const l=i.itemId,r=document.querySelectorAll("#filepond--item-"+l+" .filepond--contao-error");for(const e of r)e.remove();if(!(!0===this.jsConfig.chunking&&this.jsConfig.chunkSize>0&&t.size>this.jsConfig.chunkSize)){const i=new FormData;i.append(e,t,t.name),i.append("REQUEST_TOKEN",this.jsConfig.csrfToken),i.append("action","filepond_upload"),i.append("filePondItemId",l);const r=new XMLHttpRequest;return r.open("POST",window.location.href),r.setRequestHeader("Accept","application/json"),r.setRequestHeader("name",this.name),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.setRequestHeader("filePondItemId",l),r.upload.onprogress=e=>{o(e.lengthComputable,e.loaded,e.total)},r.onload=()=>{if(r.status>=200&&r.status<300){const e=JSON.parse(r.response);!0===e.success?!0===e.directUpload?s(""):s(e.transferKey):n(e.error||"Upload error")}else n("Upload error")},r.send(i),{abort:()=>{r.abort(),a()}}}let d=0,p=!1,h=null,u=this.jsConfig.chunkSize;const g=()=>{if(p)return;const e=t.slice(d,d+u),i=new FormData;i.append("chunk",e),i.append("fileName",t.name),i.append("offset",d),i.append("totalSize",t.size),i.append("REQUEST_TOKEN",this.jsConfig.csrfToken),i.append("action","filepond_upload_chunk");const a=new XMLHttpRequest;h=a,a.open("POST",window.location.href),a.setRequestHeader("Accept","application/json"),a.setRequestHeader("name",this.name),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.setRequestHeader("filePondItemId",l),a.upload.onprogress=e=>{const i=d+e.loaded;o(!0,i,t.size)},a.onload=()=>{if(a.status>=200&&a.status<300){const i=JSON.parse(a.response);if(!i.success)return void n(i.error||"Chunk upload failed");d+=e.size,d<t.size?g():!0===i.directUpload?s(""):s(i.transferKey)}else n("Upload error")},a.onerror=()=>{n("Network error")},a.send(i)};return g(this.jsConfig.chunkSize),{abort:()=>{p=!0,h&&h.abort(),a()}}},fetch:null,revert:null},fileValidateTypeDetectType:(e,t)=>new Promise((t,i)=>{t(`.${e.name.split(".").pop().toLowerCase()}`)})},this.#i.allowImageValidateSize=!0,this.jsConfig.maxImageWidth&&(this.#i.imageValidateSizeMaxWidth=this.jsConfig.maxImageWidth),this.jsConfig.maxImageHeight&&(this.#i.imageValidateSizeMaxHeight=this.jsConfig.maxImageHeight),this.#i.allowFileSizeValidation=!0,this.jsConfig.minSizeLimit&&(this.#i.minFileSize=this.jsConfig.minSizeLimit),this.jsConfig.maxSizeLimit&&(this.#i.maxFileSize=this.jsConfig.maxSizeLimit),this.jsConfig.allowImageResize&&(this.#t.registerPlugin(FilePondPluginImageResize,FilePondPluginImageTransform),this.#i.allowImageResize=!0,this.#i.imageResizeTargetWidth=this.jsConfig.imageResizeTargetWidth,this.#i.imageResizeTargetHeight=this.jsConfig.imageResizeTargetHeight,this.#i.imageResizeMode=this.jsConfig.imageResizeMode,this.#i.imageResizeUpscale=this.jsConfig.imageResizeUpscale)}#a(){this.wrapper.classList.add("filepond--is-ready"),setInterval(()=>{this.wrapper.querySelector('.filepond--item[data-filepond-item-state="busy processing"]')||this.wrapper.classList.remove("filepond--is-busy")},1e3)}#d(e,t){t.setMetadata("itemId",t.id)}#l(e){this.wrapper.classList.add("filepond--is-busy")}#r(e,t){if(void 0!==e?.body&&""!==e?.body){const i=e.body,s=t.id,n=document.querySelector("#filepond--item-"+s+" .filepond--file-status-main");if(n){const e=document.createElement("span");e.setAttribute("class","filepond--contao-error"),e.setAttribute("style","font-size: 0.75rem"),e.innerText=i,n.parentNode.insertBefore(e,n.nextSibling)}}}}