class ContaoFilepondPlugin{wrapper=null;widget=null;name=null;jsConfig=null;#i=!1;#t=null;#e={};#s=[FilePondPluginImagePreview,FilePondPluginImageExifOrientation,FilePondPluginFileValidateSize,FilePondPluginImageEdit,FilePondPluginFileValidateType,FilePondPluginImageValidateSize];constructor(i,t,e,s){this.wrapper=i.closest(".filepond-wrapper"),this.widget=i,this.name=t,this.jsConfig=e,this.#t=s,this.#n()}#n(){this.setAllowedExtensions(this.jsConfig.extensions),this.jsConfig.multiple?1===this.jsConfig.limit?(this.setAttribute("data-max-files",1),this.setAttribute("name",this.name),this.#i=!1):this.jsConfig.limit>1?(this.setAttribute("multiple",""),this.setAttribute("data-max-files",this.jsConfig.limit),this.setAttribute("name",this.name+"[]"),this.#i=!0):(this.setAttribute("multiple",""),this.setAttribute("name",this.name+"[]"),this.#i=!0):(this.setAttribute("data-max-files",1),this.setAttribute("name",this.name),this.#i=!1),this.jsConfig.minSizeLimit&&this.setAttribute("data-min-file-size",this.jsConfig.minSizeLimit),this.jsConfig.maxSizeLimit&&this.setAttribute("data-max-file-size",this.jsConfig.maxSizeLimit),this.setPlugins(this.#s),this.#o()}getAttribute(i){return this.widget.getAttribute(i)}setAttribute(i,t){return this.widget.setAttribute(i,t),this}removeAttribute(i){return this.widget.removeAttribute(i),this}setAllowedExtensions(i){return this.widget.setAttribute("accept",i),this}setPlugins(i){return this.#s=i,this.#t.registerPlugin(...this.#s),this}getPond(){return this.#t}getOptions(){return this.#e}setOptions(i){return this.#e=i,this}run(){this.#t.create(this.widget,this.#e)}#o(){this.#e={...this.jsConfig.translations,maxParallelUploads:this.jsConfig.maxConnections,instantUpload:!0,allowMultiple:this.#i,allowFileTypeValidation:!0,oninit:()=>{this.#a()},onaddfilestart:i=>{this.#l(i)},onprocessfile:(i,t)=>{this.#r(i,t)},onaddfile:(i,t)=>{this.#h(i,t)},server:{process:(i,t,e,s,n,o,a,l,r)=>{const h=e.itemId,d=document.querySelectorAll("#filepond--item-"+h+" .filepond--contao-error");for(const i of d)i.remove();const p=new FormData;p.append(i,t,t.name),p.append("REQUEST_TOKEN",this.jsConfig.csrfToken),p.append("action","filepond_upload");const g=new XMLHttpRequest;return g.open("POST",window.location.href),g.setRequestHeader("Accept","application/json"),g.setRequestHeader("name",this.name),g.setRequestHeader("X-Requested-With","XMLHttpRequest"),g.setRequestHeader("filePondItemId",h),g.upload.onprogress=i=>{o(i.lengthComputable,i.loaded,i.total)},g.onload=function(){if(g.status>=200&&g.status<300){const i=JSON.parse(g.response);!0===i.success?s(i.transferKey):i.error?n(i.error):n("There has been an error!")}else n("There has been an error!")},g.send(p),{abort:()=>{g.abort(),a()}}},fetch:null,revert:null},fileValidateTypeDetectType:(i,t)=>new Promise((t,e)=>{t(`.${i.name.split(".").pop().toLowerCase()}`)})},this.#e.allowImageValidateSize=!0,this.jsConfig.maxImageWidth&&(this.#e.imageValidateSizeMaxWidth=this.jsConfig.maxImageWidth),this.jsConfig.maxImageHeight&&(this.#e.imageValidateSizeMaxHeight=this.jsConfig.maxImageHeight),this.#e.allowFileSizeValidation=!0,this.jsConfig.minSizeLimit&&(this.#e.minFileSize=this.jsConfig.minSizeLimit),this.jsConfig.maxSizeLimit&&(this.#e.maxFileSize=this.jsConfig.maxSizeLimit),this.jsConfig.allowImageResize&&(this.#t.registerPlugin(FilePondPluginImageResize,FilePondPluginImageTransform),this.#e.allowImageResize=!0,this.#e.imageResizeTargetWidth=this.jsConfig.imageResizeTargetWidth,this.#e.imageResizeTargetHeight=this.jsConfig.imageResizeTargetHeight,this.#e.imageResizeMode=this.jsConfig.imageResizeMode,this.#e.imageResizeUpscale=this.jsConfig.imageResizeUpscale)}#a(){this.wrapper.classList.add("filepond--is-ready"),setInterval(()=>{this.wrapper.querySelector('.filepond--item[data-filepond-item-state="busy processing"]')||this.wrapper.classList.remove("filepond--is-busy")},1e3)}#h(i,t){t.setMetadata("itemId",t.id)}#l(i){this.wrapper.classList.add("filepond--is-busy")}#r(i,t){if(void 0!==i?.body&&""!==i?.body){const e=i.body,s=t.id,n=document.querySelector("#filepond--item-"+s+" .filepond--file-status-main");if(n){const i=document.createElement("span");i.setAttribute("class","filepond--contao-error"),i.setAttribute("style","font-size: 0.75rem"),i.innerText=e,n.parentNode.insertBefore(i,n.nextSibling)}}}}